<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>VTO</title>
    <script src="https://dsf-cdn.loreal.io/dropper.js" type="application/javascript" defer=""></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const upc = urlParams.get("upc");
            console.log("[VTO] UPC leído desde query param:", upc);

            if (!upc) {
                console.warn("[VTO] No se proporcionó ningún UPC");
                return;
            }

            const dsfApp = document.createElement("dsf-app");
            dsfApp.setAttribute("type", "std");
            dsfApp.setAttribute("tenant", "modiface");
            dsfApp.setAttribute("application", "vto");
            dsfApp.setAttribute("touchpoint", "web");
            dsfApp.setAttribute("customer", "farmashop");
            dsfApp.setAttribute("country", "ury-es");
            dsfApp.setAttribute("environment", "production");
            dsfApp.setAttribute("vto_type", "sp");
            dsfApp.setAttribute("vto_category", "make-up");
            dsfApp.setAttribute("vto_upc_list", upc);
            dsfApp.setAttribute("vto_selected_upc", upc);
            dsfApp.setAttribute("style", "width:100vw;height:100vh;display:block");

            document.body.appendChild(dsfApp);
            console.log("[VTO] <dsf-app> creado dinámicamente con UPC:", upc);

            const tryAttachCloseHandler = () => {
                const closeBtn = dsfApp?.shadowRoot?.querySelector('button.close-button');

                if (closeBtn && !closeBtn.hasAttribute('data-close-handler')) {
                    closeBtn.setAttribute('data-close-handler', 'attached');
                    closeBtn.addEventListener('click', () => {
                        location.href = 'vto_close://true';
                    });
                    console.log("[VTO] Handler de cierre adjuntado.");
                } else {
                    setTimeout(tryAttachCloseHandler, 300);
                }
            };
            tryAttachCloseHandler();
        });
    </script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    </style>
</head>
<body>
<!-- ya no va dsf-app aquí -->
</body>
</html>
